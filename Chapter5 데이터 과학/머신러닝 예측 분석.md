# 머신러닝 모델
## 머신러닝 모델이란?
머신러닝 모델은 함수와 비슷함. 머신러닝 모델도 값을 입력하면 정해진 규칙에 따라 계산한 예측값을 출력함. 머신러닝 모델이 함수와 다른 점은 만드는 방법.
머신러닝 모델을 만들 때는 사람이 계산 규칙을 정하지 않고 컴퓨터가 데이터에서 패턴을 찾아 스스로 규칙을 정하게 함.

### 예측 변수와 타겟 변수
머신러닝 모델을 만들 때 두 종류의 변수를 사용함.
* 예측 변수(predictor variable): 예측하는 데 활용하는 변수 또는 모델에 입력하는 값.
* 타겟 변수(target variable): 예측하고자 하는 변수 또는 모델이 출력하는 값.

환자의 성별, 나이 흡연 여부, 음주 여부로 당뇨병 발병을 예측하는 모델을 만든다면 성별, 나이, 흡연 여부, 음주 여부는 예측 변수로 사용. 당뇨병 발병 여부는 타겟 변수로 사용.

### 머신러닝 모델을 이용해 미래 예측
미래의 값을 예측하는 용도로 자주 사용됨. 과거의 값을 예측 변수, 미래의 값을 타겟 변수로 사용하면 됨.  
머신러닝 모델은 다양한 사업 영역에서 미래를 예측하는 데 활용됨. 미래를 예측하면 부가 수익을 창출하고 비용을 줄일 수 있으므로 머신러닝은 여러 분야에서 주목받는 기술.

## 의사결정나무 모델(decision tree)
종류가 매우 다양하고 새로운 알고리즘이 끊임없이 개발되고 있음. 의사결정나무 모델은 구조가 단순하고 작동 원리를 이해하기 쉬워 여러 분야에 사용됨. 규모가 크고 복잡한 모델도 의사결정나무 모델에 기반을 두고 만들 때가 많음.

### 의사결정나무 모델이란?
의사결정나무 모델은 순서대로 주어진 질문에 yes/no로 답하면 마지막에 결론을 얻는 구조.

### 의사결정나무 모델을 이용해 예측
최종적으로 둘 중 한 가지 값으로 분류하는 모델은 이진 분류 모델(binary classification model).  
셋 이상의 값으로 분류하는 모델은 다중 분류 모델(multiclass classification model).

### 의사결정나무 모델 원리
* 예측 변수: 흡연 여부, 음주 여부, 성별, 나이
* 타겟 변수: 당뇨병 발병 여부

#### 1단계: 타겟 변수를 가장 잘 분리하는 예측 변수 선택
의사결정나무 모델은 어떤 순서로 어떤 질문을 할지 정하는 과정을 거쳐 만들어짐. 첫 번째 질문을 할 때 예측 변수 중에서 무엇을 사용할지 정함.
'타겟 변수를 가장 잘 분리해 주는 예측 변수'를 찾아 첫 번째 질문으로 삼음. 예측 변수가 타겟 변수를 분리해 주는 정도는 아래 절차로 알 수 있음.

1. 모든 예측 변수를 yes/no로 답할 수 있는 질문으로 만듦
2. 모델을 만드는데 사용할 데이터를 앞에서 만든 각각의 질문에 대입한 다음 'yes'로 답한 데이터만 추출함.
3. 발병인과 정상인의 비율을 구함. 비율 차이가 크면 클수록 예측 변수가 타겟 변수를 잘 분리하는 것.

연속 변수는 타겟 변수를 가장 잘 분리해 주는 기준을 알아내려면 모든 경우의 수대로 질문 후보를 만들어 비교함.  
모든 예측 변수로 질문을 만든 다음 타겟 변수를 가장 잘 분리해 주는 변수를 찾아 첫 번째 질문에 사용함. 실제 계산에서는 노드 분리 전후를 비교하여 지니 계수(gini index)나 엔트로피(entropy)와 같은 불순도(impurity)를 가장 줄여주는 예측 변수를 선택함.

#### 2단계: 첫 번째 질문의 답변에 따라 데이터를 두 노드로 분할
질문의 답변이 같아서 함께 분류된 집단을 노드(node)라고 함. 의사결정나무 도식에 사각형으로 표현됨.

#### 3단계: 각 노드에서 타겟 변수를 가장 잘 분리하는 예측 변수 선택
각 노드에서 타겟 변수를 가장 잘 분리해 주는 예측 변수 선택. 1단계 작업을 노드별로 반복하는 것.

#### 4단계: 노드가 완벽하게 분리될 때까지 반복
한 범주만 남아 완벽하게 분리될 때까지 변수를 선택하고 노드를 분할하는 과정을 반복함.

### 의사결정나무 모델 특징
#### 노드마다 분할 횟수가 다름
예측 변수를 선택하고 노드를 분할하는 횟수가 노드마다 다르므로 가지가 뻗어 나간 횟수도 노드마다 제각각.

#### 노드마다 선택되는 예측 변수가 다름
예측 변수 선택 작업을 노드별로 따로 하므로 노드마다 선택되는 변수가 다름.

#### 어떤 예측 변수는 모델에서 탈락
어떤 예측 변수는 노드를 분할하는 과정에서 한 번도 선택되지 않아 모델에서 탈락할 수 있음. 데이터에 들어 있는 모든 변수를 예측해 사용하는 게 아니라 일부는 사용하고 일부는 제외.


# 소득 예측 모델
adult 데이터는 미국인의 성별, 인종, 직업, 학력 등 다양한 인적 정보를 담고 있는 인구 조사 데이터. adult 데이터를 이용해 인적 정보로 소득을 예측하는 의사결정나무 모델 만들기.
모델을 만드는 절차  
1. 전처리
2. 모델 만들기
3. 예측 및 성능 평가

먼저 adult 데이터를 불러와 구조 살펴보기.
```
import pandas as pd
df = pd.read_csv('adult.csv')
df.info()
```
> adult 데이터 출처: bit.ly/easypy_143

adult 데이터는 48,842명의 정보를 담고 있으며 변수 15개로 구성됨. 이 중 연소득을 나타낸 income을 타겟 변수, 나머지 14개를 예측 변수로 사용하기.
|변수명|의미|
|:--|:--|
|age|나이|
|workclass|근로 형태|
|fnlwgt|인구 통계 가중치|
|education|최종 학력|
|education_num|교육 기간|
|marital_status|결혼 상태|
|occupation|직종|
|relationship|가구주와의 관계|
|race|인종|
|sex|성별|
|capital_gain|자본 소득(USD)|
|capital_loss|자본 손실(USD)|
|hours_per_week|주당 근무 시간|
|native_country|출신 국가|
|income|연소득|

#### 소득 예측 모델 활용
1. 고가 상품 구매 프로모션
소득 예측 모델은 고가의 상품을 구매하도록 독려하는 프로모션에 활용 가능. 소득이 높아 상품을 구매할 가능성이 높은 사람을 예측하면 프로모션 활동에 드는 시간과 비용을 절약 가능.

2. 저소득층 지원 대상 확대
저소득층 지원 사업 대상자를 찾아낼 때에도 소득 예측 모델을 활용 가능. 저소득층을 선제적으로 찾아 지원하면 사람들이 스스로 지원 요건을 확인하고 신청하게 할 때보다 복지 프로그램 대상을 확대 가능.

## 전처리(data preprocessing)
머신러닝 모델을 만들 때 가장 먼저 하는 작업은 데이터를 가공하는 것. 모델을 만들기 전에 데이터를 처리하는 작업이므로 데이터 전처리라고 함. adult 데이터를 전처리하기.

### 타겟 변수 전처리
타겟 변수 income을 검토하고 전처리. income은 조사 응답자의 연소득이 5만 달러를 초과하는지 여부를 나타냄. 연소득이 5만 달러를 초과하는 사람(>50K)은 23.9%, 5만 달러 이하인 사람(<=50K)은 76%.
```
df['income'].value_counts(normalize = True)
```
> df.value_counts()에 normalize = True를 입력하면 범주의 비율을 구함.

변수의 값에 특수문자나 대소문자가 섞여 있으면 다루기 불편하므로 5만 달러를 초과하면 'high', 그렇지 않으면 'low'로 값을 수정함. '>50K'에서 'K'는 대문자.
```
import numpy as np
df['income'] = np.where(df['income'] == '>50K', 'high', 'low')
df['income'].value_counts(normalize = True)
```

### 불필요한 변수 제거
이름, 아이디, 주소 같은 변수는 대부분의 값이 고유값이어서 반복되는 패턴이 없고 타겟 변수와도 관련성이 없음. 이런 변수는 타겟 변수를 예측하는 데 도움이 되지 않고 모델링 시간만 늘리는 역할을 하므로 제거해야 함.  
fnlwgt는 adult 데이터를 이용해 미국의 실제 인구를 추정할 때 사용하는 가중치. 인종, 성별, 나이 등 인구 통계 속성이 같으면 fnlwgt가 같음. fnlwgt는 타겟 변수를 예측하는 데 도움이 되지 않는 변수이므로 모델을 만들 때 사용하지 않도록 제거해야함.
```
df = df.drop(columns = 'fnlwgt')
```

### 문자 타입 변수를 숫자 타입으로 바꾸기
모델을 만드는 데 사용되는 모든 변수는 숫자 타입이어야 함. df.info()의 출력 결과를 보면 Dtype이 object인 문자 타입 변수들이 있음. 변수들을 모델을 만드는 데 활용하려면 숫자 타입으로 바꿔야 함.

#### 원핫 인코딩
변수의 범주가 특정 값이면 1, 그렇지 않으면 0으로 바꾸면 문자 타입 변수를 숫자 타입으로 만들 수 있음. 값을 1과 0으로 바꾸는 방법을 원핫 인코딩(one-hot encoding)이라 함.  
df의 sex를 추출해 원핫 인코딩하는 방법 알아보기. df_tmp의 sex는 'Male' 또는 'Female'로 되어 있는 문자 타입 변수.
```
df_tmp = df[['sex']]
df_tmp.info()
```
```
df_tmp['sex'].value_counts()
```
pd.get_dummies()에 데이터 프레임을 입력하면 문자 타입 변수를 원핫 인코딩을 적용해 변환함. 출력 결과를 보면 sex가 사라지고 그 대신 sex_Female과 sex_Male이 만들어짐.
```
# df_tmp의 문자 타입 변수에 원핫 인코딩 적용
df_tmp = pd.get_dummies(df_tmp)
df_tmp.info()
```
> 원핫 인코딩으로 만들어진 변수의 타입은 unit8. unit8은 0~255의 양수를 담을 수 있는 데이터 타입.

sex_Female은 sex가 Female이면 1, 그렇지 않으면 0으로 된 변수. sex_Male은 반대로 sex가 Male이면 1, 그렇지 않으면 0으로 된 변수.
```
df_tmp[['sex_Female', 'sex_Male']].head()
```
원핫 인코딩을 df에 적용. 타겟 변수인 income만 원래대로 유지, 모든 문자 타입 변수를 원핫 인코딩.
```
target = df['income']    # income 추출

df = df.drop(columns = 'income')    # income 제거
df = pd.get_dummies(df)             # 문자 타입 변수 원핫 인코딩

df['income'] = target               # df에 target 삽입
df.info()
```
df.info() 출력 결과에 개별 변수의 정보가 출력되지 않은 이유는 변수가 100개 이하일 때만 변수 정보를 출력하도록 설정되어 있기 때문. df.info()에 max_cols = np.inf를 입력하면 변수의 수와 관계없이 모든 변수의 정보를 출력함. 출력 결과를 보면 변수가 108개로 늘어나고, 문자 타입 변수가 전부 숫자 타입으로 바뀌었다는 것을 알 수 있음.
```
import numpy as np
df.info(max_cols = np.inf)
```
### 데이터 분할하기
